# Common Media Library AI Agent Instructions

## Project Mission

Common Media Library (CML) is a collection of TypeScript libraries implementing media specifications (CMCD, CMSD, ID3, ISO BMFF, WebVTT, DASH, and more) for use by web video players such as hls.js, dash.js, and shaka-player.

The strategic goal is **widespread adoption**. Evaluate every decision against these priorities, in order:

1. **Performance** — Avoid unnecessary runtime overhead, memory leaks, and GC thrashing. This code runs on every video playback.
2. **Tree-shakeability** — Adopters' final bundle size is what matters. Users must only pay for what they import.
3. **Developer experience** — Correct usage should be obvious; incorrect usage should fail at compile time.
4. **Documentation quality** — Adopters evaluate libraries by their docs before reading source code.
5. **Minimal barriers to entry** — Zero config, no peer dependencies, copy-pasteable examples.
6. **Spec compliance** — Implementations must be accurate to the relevant specification. Do not invent extensions.

## Build Commands

- `npm run build -w <workspace>`: Build a module
- `npm run typecheck`: Run the typechecker
- `npm test -w <workspace>`: Run the tests for a module (build first — tests use bundled output)
- `npm run format`: Run the formatter
- `npm run ver <package> <version>`: Update version for a package (`<package>` is the folder name without `libs/` prefix)

## Developer Experience

APIs are the product. Design them so adopters fall into the pit of success:

- Use union and literal types so autocomplete guides users to valid values.
- Actionable error messages: include parameter name, expected value(s), and received value.
- Minimal API surface — do not add a public export unless it serves a clear use case.
- Follow established naming and structural patterns across packages (e.g., `encode`/`decode`, options objects, const enum pattern).

## Workflow

- Typecheck the entire project after code changes
- Prefer builds and tests at the workspace level
- Create tests for new public API members
- Update `package.json` version (semver) and `CHANGELOG.md` for every change
- When a package's version changes, patch-bump any packages that depend on it
- Avoid breaking changes; when unavoidable, provide migration guidance in changelog and docs

## Documentation

- Every package needs a `README.md` with description, install instructions, and a quick-start example.
- Use `{@includeCode ../test/<file>.test.ts#example}` in TSDoc to reference test examples.
- Mark example regions in tests with `// #region example` and `// #endregion example`.
- All code examples must be complete and runnable — no pseudocode, no elided imports.
- Public API changes are tracked in `config/cml-*.api.md` (regenerated by build).

## Git Commit Guidelines

- **Always use `git commit -s`** to add the DCO sign-off. Every commit must have this.
- Follow conventional commit format (`feat:`, `fix:`, `refactor:`, `chore:`, etc.).
